name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install backend dependencies
      run: |
        cd backend
        npm install --production

    - name: Install frontend dependencies and build
      run: |
        cd frontend
        npm install
        npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy

        # Copier le backend (sans node_modules, on les copiera séparément)
        cp -r backend deploy/

        # Copier le frontend buildé
        mkdir -p deploy/frontend
        cp -r frontend/dist deploy/frontend/
        cp frontend/package.json deploy/frontend/

        # Créer une archive
        tar -czf deploy.tar.gz -C deploy .

    - name: Backup data on VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          # Créer le dossier de l'application s'il n'existe pas
          mkdir -p /var/www/intervention-tracker

          # Sauvegarder les données existantes
          if [ -d "/var/www/intervention-tracker/backend/data" ]; then
            echo "Sauvegarde des données..."
            mkdir -p /tmp/intervention-tracker-backup
            cp -r /var/www/intervention-tracker/backend/data /tmp/intervention-tracker-backup/
          fi

    - name: Copy files to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        source: "deploy.tar.gz"
        target: "/tmp/"

    - name: Deploy on VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          # Extraire l'archive dans un dossier temporaire
          mkdir -p /tmp/intervention-tracker-deploy
          cd /tmp/intervention-tracker-deploy
          tar -xzf /tmp/deploy.tar.gz
          rm /tmp/deploy.tar.gz

          # Créer le dossier de destination s'il n'existe pas
          sudo mkdir -p /var/www/intervention-tracker

          # Restaurer les données avant de copier les nouveaux fichiers
          if [ -d "/tmp/intervention-tracker-backup/data" ]; then
            echo "Sauvegarde temporaire des données..."
            cp -r /tmp/intervention-tracker-backup/data /tmp/intervention-tracker-deploy/backend/
          fi

          # Arrêter l'application avant de remplacer les fichiers
          pm2 stop intervention-tracker-backend || true

          # Remplacer les fichiers (avec sudo si nécessaire)
          sudo rsync -av --delete /tmp/intervention-tracker-deploy/ /var/www/intervention-tracker/

          # Nettoyer les backups
          rm -rf /tmp/intervention-tracker-backup
          rm -rf /tmp/intervention-tracker-deploy

          # S'assurer que le dossier data existe avec les bonnes permissions
          sudo mkdir -p /var/www/intervention-tracker/backend/data
          sudo chown -R $USER:$USER /var/www/intervention-tracker
          sudo chmod -R 755 /var/www/intervention-tracker

          # Redémarrer l'application avec PM2
          cd /var/www/intervention-tracker/backend
          pm2 restart intervention-tracker-backend || pm2 start server.js --name intervention-tracker-backend

          # Vérifier le statut
          pm2 status

          echo "✅ Déploiement terminé avec succès!"
